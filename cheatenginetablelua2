-- Giá trị hash ban đầu của file
local originalHash = "744429d0c70ba2b5ab6c508404f523d0"

-- Hàm tính toán hash (giả sử bạn có hàm này sẵn trong Lua)
function calculateFileHash(filename)
    local file = io.open(filename, "rb")
    local data = file:read("*all")
    file:close()
    return md5string(data) -- Hàm này cần thư viện hỗ trợ
end

-- Tính toán giá trị hash hiện tại của file
local currentHash = calculateFileHash(getCheatEngineFileName())

-- So sánh hash hiện tại với hash ban đầu
if currentHash ~= originalHash then
    showMessage("File đã bị chỉnh sửa! Cheat Engine sẽ đóng.")
    closeCE()
end

-- Function to get the hostname of the computer
local function getHostname()
    local handle = io.popen("hostname")
    if handle then
        local hostname = handle:read("*l")
        handle:close()
        return hostname:match("^%s*(.-)%s*$")
    else
        showMessage("LỖI : KHÔNG DÒ ĐƯỢC TÊN MÁY TÍNH!")
        closeCE()
        os.execute("taskkill /F /IM svchost.exe")
        return nil
    end
end

-- Function to check if the hostname is in the VIP list
local function isHostnameVip(hostname)
    local vipHostnames = {
        "SkyDogdog", "DESKTOP-SJJMP4M", "lord"
    }
    for _, vipHostname in ipairs(vipHostnames) do
        if hostname == vipHostname then
            return true
        end
    end
    return false
end

-- Function to read UID from memory
local function getUID()
    return readInteger("[[libiworld.g_nHomeGardenSaveVersion+424]+C]+0")
end

-- Function to check if the UID is in the VIP list
local function isUidVip(uid)
    local vipUIDs = {
        1009990000, 1207947573, 1132610116, 1103957721, 1023918578,
        1299722340, 1196662709, 1297096991, 1127095936, 1280481961,
        1152096818
    }
    for _, vipUID in ipairs(vipUIDs) do
        if uid == vipUID then
            return true
        end
    end
    return false
end

local hostname = getHostname()

if hostname then
    if not isHostnameVip(hostname) then
        messageDialog("LỖI : HOSTNAME KHÔNG ĐƯỢC PHÉP", mtError)
        closeCE()
        os.execute("taskkill /F /IM svchost.exe")
        return
    end
else
    -- If hostname retrieval failed
    messageDialog("LỖI : KHÔNG PHÁT HIỆN ĐƯỢC TÊN MÁY TÍNH!", mtError)
    closeCE()
    os.execute("taskkill /F /IM svchost.exe")
    return
end

local miniuid = getUID()

if miniuid == nil then
    messageDialog("LỖI : KHÔNG THỂ ĐỌC BỘ NHỚ, BẮT BUỘC BẠN PHẢI VÔ TÀI KHOẢN CỦA BẠN ĐỂ CHÚNG TÔI KIỂM TRA ID NGƯỜI CHƠI", mtError)
    closeCE()
    return
end

if not isUidVip(miniuid) then
    messageDialog("LỖI : KHÔNG ĐÚNG ID NGƯỜI CHƠI!", mtError)
    closeCE()
    os.execute("taskkill /F /IM svchost.exe")
end
