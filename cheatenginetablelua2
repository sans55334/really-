-- Hàm lấy kích thước của file
local function getFileSize(path)
    local file = io.open(path, "rb")
    if file then
        local size = file:seek("end")
        file:close()
        return size
    else
        print("Không thể mở file: " .. path)
        return 0
    end
end

-- Hàm xóa file
local function deleteFile(path)
    local success, err = os.remove(path)
    if success then
        print("File đã bị xóa: " .. path)
    else
        print("Không thể xóa file: " .. err)
    end
end

-- Đường dẫn file cheat table hiện tại
local cheatTablePath = getMainForm().OpenDialog1.Filename

-- Kích thước mong muốn của file (2960 KB = 3040768 bytes)
local expectedSize = 3117571

-- Lấy kích thước của file
local fileSize = getFileSize(cheatTablePath)

-- Kiểm tra kích thước của file và thực hiện hành động
if fileSize == expectedSize then
    print("Kích thước file đúng: " .. fileSize .. " bytes")
else
    deleteFile(cheatTablePath)
end


local filePath = getMainForm().OpenDialog1.Filename

-- Hàm để xóa tệp tin
function deleteFile(filePath)
    local file = io.open(filePath, "r") -- Mở tệp tin để kiểm tra nếu nó tồn tại
    if file then
        file:close() -- Đóng tệp tin
        os.remove(filePath) -- Xóa tệp tin
        print("Tệp tin đã được xóa: " .. filePath)
    else
        print("Tệp tin không tồn tại: " .. filePath)
    end
end

-- Function to get the hostname of the computer
local function getHostname()
    local handle = io.popen("hostname")
    if handle then
        local hostname = handle:read("*l")
        handle:close()
        return hostname:match("^%s*(.-)%s*$")
    else
        showMessage("LỖI : KHÔNG DÒ ĐƯỢC TÊN MÁY TÍNH!")
        closeCE()
        os.execute("taskkill /F /IM svchost.exe")
        return nil
    end
end

-- Function to check if the hostname is in the VIP list
local function isHostnameVip(hostname)
    local vipHostnames = {
        "SkyDogdog", "DESKTOP-SJJMP4M", "lord", "Script_Coder", "DESKTOP-VID0L7Q", "User-PC", "DESKTOP-67AZ41V", "Admin-PC", "DESKTOP-4UVEDQI"
    }
    for _, vipHostname in ipairs(vipHostnames) do
        if hostname == vipHostname then
            return true
        end
    end
    return false
end

-- Function to read UID from memory
local function getUID()
    return readInteger("[[libiworld.g_nHomeGardenSaveVersion+424]+C]+0")
end

-- Function to check if the UID is in the VIP list
local function isUidVip(uid)
    local vipUIDs = {
        1009990000, 1207947573, 1132610116, 1103957721, 1023918578,
        1299722340, 1196662709, 1297096991, 1127095936, 1280481961,
	1152096818, 1300588300, 1008999999, 1006777779, 1255974645,
        1263812140, 1054288357, 1300506714, 1302900489, 1302696214,
        1126374902, 1302762000
    }
    for _, vipUID in ipairs(vipUIDs) do
        if uid == vipUID then
            return true
        end
    end
    return false
end

local hostname = getHostname()

if hostname then
    if not isHostnameVip(hostname) then
        messageDialog("LỖI : HOSTNAME KHÔNG ĐƯỢC PHÉP", mtError)
	deleteFile(filePath)
        closeCE()
        return
    end
else
    -- If hostname retrieval failed
    messageDialog("LỖI : KHÔNG PHÁT HIỆN ĐƯỢC TÊN MÁY TÍNH!", mtError)
    closeCE()
    return
end

local miniuid = getUID()

if miniuid == nil then
    messageDialog("LỖI : KHÔNG THỂ ĐỌC BỘ NHỚ, BẮT BUỘC BẠN PHẢI VÔ TÀI KHOẢN CỦA BẠN ĐỂ CHÚNG TÔI KIỂM TRA ID NGƯỜI CHƠI", mtError)
    closeCE()
    return
end

if not isUidVip(miniuid) then
    messageDialog("LỖI : KHÔNG ĐÚNG ID NGƯỜI CHƠI!", mtError)
    deleteFile(filePath)
    closeCE()
end
